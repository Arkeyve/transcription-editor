function setCookie(e,t){var r=new Date;r.setTime(r.getTime()+2592e6),document.cookie=e+"="+t+"; expires="+r.toUTCString()+"; path=/"}function toHHMMssmmm(e){var t=parseInt(1e3*e,10),r=Math.floor(t/36e5);t%=36e5;var i=Math.floor(t/6e4);t%=6e4;var s=Math.floor(t/1e3);return t%=1e3,r<10&&(r="0"+r),i<10&&(i="0"+i),s<10&&(s="0"+s),t<100&&(t=t<10?"00"+t:"0"+t),r+":"+i+":"+s+","+t}function togglePlayPause(){document.getElementById("playpause").classList.toggle("fa-play"),document.getElementById("playpause").classList.toggle("fa-pause")}function activeSpeed(){var e={.5:0,1:1,1.25:2,1.5:3,1.75:4,2:5},t=document.querySelectorAll(".speed");[].forEach.call(t,function(e){e.classList.remove("activespeed")}),t[e[wavesurfer.backend.playbackRate]].classList.add("activespeed")}function loadJSON(e,t){var r=new XMLHttpRequest;r.onreadystatechange=function(){4===this.readyState&&200===this.status&&t(this.responseText)},r.open("GET",e,!0),r.send()}function getHighlights(){var e=Array();if([].forEach.call(document.getElementsByClassName("highlight"),function(t){e.push({start:Number(t.getAttribute("starttime")),end:Number(t.getAttribute("endtime"))})}),highlights={},e.length>0){highlights[0]=Number(e[0].start.toFixed(1));for(var t=0;t<e.length-1;t++)Number(e[t+1].start.toFixed(1))>Number(e[t].end+.2).toFixed(1)&&(highlights[(e[t].end-.2).toFixed(1)]=Number(e[t+1].start.toFixed(1)),highlights[(e[t].end-.1).toFixed(1)]=Number(e[t+1].start.toFixed(1)),highlights[e[t].end.toFixed(1)]=Number(e[t+1].start.toFixed(1)),highlights[(e[t].end+.1).toFixed(1)]=Number(e[t+1].start.toFixed(1)),highlights[(e[t].end+.2).toFixed(1)]=Number(e[t+1].start.toFixed(1)));e.length>1&&(highlights[(e[t].end-.2).toFixed(1)]=highlights[0],highlights[(e[t].end-.1).toFixed(1)]=highlights[0],highlights[e[t].end.toFixed(1)]=highlights[0],highlights[(e[t].end+.1).toFixed(1)]=highlights[0],highlights[(e[t].end+.2).toFixed(1)]=highlights[0])}}function getStrikes(){var e=Array();[].forEach.call(document.getElementsByClassName("strike"),function(t){e.push({start:Number(t.getAttribute("starttime")),end:Number(t.getAttribute("endtime"))})}),strikes={};for(var t,r,i=0;i<e.length;i++){for(t=e[i].start.toFixed(1);i<e.length-1&&e[i].end.toFixed(1)===e[i+1].start.toFixed(1);)i++;(r=Number(e[i].end.toFixed(1)))>Number(t)+.2&&(strikes[(Number(t)-.2).toFixed(1)]=r,strikes[(Number(t)-.1).toFixed(1)]=r,strikes[t]=r,strikes[(Number(t)+.1).toFixed(1)]=r,strikes[(Number(t)+.2).toFixed(1)]=r)}}function showExport(e){var t=document.getElementById("export-wrapper");t.setAttribute("style","top: "+e.clientY+"px; left: "+e.clientX+"px;"),t.classList.remove("hidden"),setTimeout(function(){t.classList.remove("invisible")},50)}function showHelp(e){var t=document.getElementById("help-wrapper");t.classList.remove("hidden"),setTimeout(function(){t.classList.remove("invisible")},50)}function enableUI(){document.getElementById("loader").classList.toggle("spinning"),document.getElementById("main-container-mask").classList.toggle("invisible"),setTimeout(function(){document.getElementById("main-container-mask").setAttribute("style","display: none")},30)}function seekToWord(e){wavesurfer.seekTo(e.id/wavesurfer.getDuration())}function resizeBody(){wavesurfer.drawBuffer(),wavesurfer.drawer.progress(wavesurfer.backend.getPlayedPercents());var e=document.getElementsByClassName("main-container")[0].offsetHeight,t=window.innerHeight-e;document.getElementsByClassName("transcript-container")[0].setAttribute("style","height: "+t+"px"),document.getElementById("text-options").setAttribute("style","margin-top: "+e+"px")}function fillWords(){for(var e,t=transcript.results[0].results,r=transcript.results[0].speaker_labels,i=(Array(),Array(),0),s=0,n=document.getElementById("transcript-area");n.hasChildNodes();)n.removeChild(n.lastChild);t.forEach(function(t,a){var o;t.alternatives.forEach(function(t,r){t.confidence>0&&(o=t,e=r)});var l,d,c,u,m;o.timestamps.forEach(function(t,o){if((l=r[i++].speaker)!=d){if(c){n.appendChild(c);var p=document.createElement("br");p.classList.add("special-break"),n.appendChild(p)}(c=document.createElement("div")).setAttribute("title",l),c.classList.add("speaker-div"),(u=document.createElement("input")).value=l,u.classList.add("speaker"),u.setAttribute("readonly",""),u.setAttribute("speakername",l),u.setAttribute("speakerindex",i-1),u.setAttribute("style","width: "+(8*u.value.length+20)+"px"),u.setAttribute("onkeyup","resizeInput(this);"),u.setAttribute("onclick","handleList(this)"),u.setAttribute("onblur","handleValue(this)"),u.setAttribute("onchange","changeInput(this);"),n.appendChild(u)}if(""!=t[0].trim()){(m=document.createElement("span")).innerHTML=t[0],m.setAttribute("starttime",t[1]),m.setAttribute("endtime",t[2]),m.setAttribute("oldval",t[0]),m.setAttribute("resultindex",a),m.setAttribute("alternativeindex",e),m.setAttribute("wordindex",o),m.setAttribute("speakerindex",s),m.setAttribute("title",t[1]+" - "+t[2]),m.setAttribute("tabindex","-1"),m.addEventListener("focus",function(){seekToWord(this)}),m.id=t[1],m.classList.add("word");var g="h"+t[1],h="s"+t[1];t[3]?t[3].highlight?(m.classList.add("highlight"),g in wavesurfer.regions.list||wavesurfer.addRegion({id:g,start:m.getAttribute("starttime"),end:m.getAttribute("endtime"),color:"rgba(255, 255, 0, 0.3)",drag:!1,resize:!1})):t[3].strike?(m.classList.add("strike"),h in wavesurfer.regions.list||wavesurfer.addRegion({id:h,start:m.getAttribute("starttime"),end:m.getAttribute("endtime"),color:"rgba(100, 100, 100, 0.5)",drag:!1,resize:!1})):(g in wavesurfer.regions.list&&wavesurfer.regions.list[g].remove(),h in wavesurfer.regions.list&&wavesurfer.regions.list[h].remove()):(g in wavesurfer.regions.list&&wavesurfer.regions.list[g].remove(),h in wavesurfer.regions.list&&wavesurfer.regions.list[h].remove()),c.appendChild(m)}s++,d=l}),n.appendChild(c);var p=document.createElement("br");p.classList.add("special-break"),n.appendChild(p)}),[].forEach.call(document.querySelectorAll(".word"),function(e){wordObserver.observe(e,{characterData:!0,subtree:!0}),wordChildObserver.observe(e,{childList:!0})}),[].forEach.call(document.querySelectorAll(".speaker-div"),function(e){nodeObserver.observe(e,{childList:!0})}),getHighlights(),getStrikes()}function readWords(){function e(){t.top+150>=currWord.getBoundingClientRect().top?clearInterval(r):document.getElementById("transcript-area").scrollTop+=5}function e(){t.top+100<=currWord.getBoundingClientRect().top?clearInterval(i):document.getElementById("transcript-area").scrollTop-=5}readWord=document.getElementsByClassName("read");try{currWord=readWord[0]?readWord[readWord.length-1].nextSibling?readWord[readWord.length-1].nextSibling:readWord[readWord.length-1].parentElement.nextSibling.nextSibling.nextSibling.firstChild:document.getElementsByClassName("word")[0]}catch(e){currWord=document.getElementsByClassName("word")[0]}var t=document.getElementById("transcript-area").getBoundingClientRect();if(currWord.id<wavesurfer.getCurrentTime()){for(;currWord&&currWord.id<wavesurfer.getCurrentTime();)currWord.classList.add("read"),currWord=currWord.nextSibling?currWord.nextSibling:currWord.parentElement.nextSibling.nextSibling.nextSibling.firstChild;if((t.bottom<currWord.getBoundingClientRect().bottom||t.top>currWord.getBoundingClientRect().top)&&currWord.scrollIntoView(),t.top+150<currWord.getBoundingClientRect().top)var r=setInterval(e,10)}else if([].forEach.call(document.querySelectorAll(".read"),function(e){e.id>wavesurfer.getCurrentTime()&&e.classList.remove("read")}),readWord=document.getElementsByClassName("read"),currWord=readWord[readWord.length-1],currWord&&((t.bottom<currWord.getBoundingClientRect().bottom||t.top>currWord.getBoundingClientRect().top)&&currWord.scrollIntoView(),t.top+100>currWord.getBoundingClientRect().top))var i=setInterval(e,10)}function checkDeepLink(e){if("t"in e){var t=0;e.t=e.t.toLowerCase(),e.t.split("h").length>1&&(t+=3600*Number(e.t.split("h")[0]),e.t=e.t.split("h")[1]),e.t.split("m").length>1&&(t+=60*Number(e.t.split("m")[0]),e.t=e.t.split("m")[1]),e.t.split("s").length>1&&(t+=Number(e.t.split("s")[0]),e.t=e.t.split("s")[1]);var r=t/wavesurfer.getDuration();r<=1&&wavesurfer.seekTo(r)}}function getParameters(){var e={};return window.location.search.slice(1).split("&").forEach(function(t){var r=t.split("=");e[r[0]]=r[1]}),e}function getURLs(e){var t=new XMLHttpRequest;t.onreadystatechange=function(){4===this.readyState&&200===this.status?(pageOptions=JSON.parse(this.responseText)).metaURL&&pageOptions.transcriptURL&&pageOptions.audioURL?init():alert("Missing parameters. Please try later."):4===this.readyState&&200!=this.status&&alert("Server response invalid. Please try later.")},t.open("POST","./save.php",!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.send("id="+e)}function updateTime(){var e=wavesurfer.getCurrentTime(),t=wavesurfer.getDuration(),r=toHHMMssmmm(e).split(",")[0],i=toHHMMssmmm(t-e).split(",")[0];document.getElementById("elapsed-time").innerText=r,document.getElementById("remaining-time").innerText=i}function init(){/hints=off/i.test(document.cookie)&&GLOBAL_ACTIONS["toggle-hints"](),/help=off/i.test(document.cookie)&&(GLOBAL_ACTIONS["toggle-help"](),GLOBAL_ACTIONS["close-help"]());var e={container:document.querySelector("#audioclip"),progressColor:"#f4364c",waveColor:"#3f88c5",cursorWidth:2,cursorColor:"#3f88c5",barWidth:2,normalize:!0,backend:"MediaElement",hideScrollbar:!0,height:95};wavesurfer.init(e),loadJSON(pageOptions.metaURL,function(e){var t=JSON.parse(e);silences=t.silences,wavesurfer.load(pageOptions.audioURL,t.peaks,"none")}),wavesurfer.on("audioprocess",function(){curr=wavesurfer.getCurrentTime().toFixed(1),readWords(),updateTime(),curr in strikes&&wavesurfer.backend.seekTo(strikes[curr]),playHighlights&&curr in highlights&&wavesurfer.backend.seekTo(highlights[curr]),skipSilences&&curr in silences&&wavesurfer.backend.seekTo(silences[curr])}),wavesurfer.on("finish",function(){GLOBAL_ACTIONS.stop()}),wavesurfer.on("seek",function(){readWords(),updateTime()}),wavesurfer.on("ready",function(){var e=Object.create(WaveSurfer.Timeline),t=100*Math.floor(wavesurfer.getDuration()/1e3)/2;e.init({wavesurfer:wavesurfer,container:"#audioclip-timeline",primaryColor:"#3f88c5",seondaryColor:"#f4364c",primaryFontColor:"#f6f7eb",secondaryFontColor:"#f6f7eb",timeInterval:t,height:15}),updateTime(),wavesurfer.addRegion({id:"dummy",start:0,end:0,drag:!1,resize:!1,color:"rgba(255, 255, 0, 0)"}),resizeBody(),enableUI(),activeSpeed(),nodeObserver=new MutationObserver(function(e){nodeMutation(e)}),wordObserver=new MutationObserver(function(e){wordMutation(e)}),wordChildObserver=new MutationObserver(function(e){wordChildMutation(e)}),loadJSON(pageOptions.transcriptURL,function(e){transcript=JSON.parse(e),fillWords(),checkDeepLink(getParams)}),setInterval(function(){saveJSON(!1)},6e4)}),[].forEach.call(document.querySelectorAll("[data-action]"),function(e){e.addEventListener("click",function(e){var t=e.currentTarget.dataset.action;t in GLOBAL_ACTIONS&&(e.preventDefault(),GLOBAL_ACTIONS[t]())})}),document.getElementById("volumerange").addEventListener("change",function(){wavesurfer.setVolume(this.value/100)});var t=document.getElementById("shortcut-wrapper"),r=(document.getElementById("shift-key"),document.getElementById("space-key")),i=document.getElementById("extra-key");document.addEventListener("keydown",function(e){var s={32:"play",82:"rewind"};if(e.ctrlKey){t.classList.remove("hidden");var n=s[e.keyCode];n in GLOBAL_ACTIONS&&(e.preventDefault(),32==e.keyCode?r.classList.remove("hidden"):(i.innerHTML=e.key.toUpperCase(),i.classList.remove("hidden")),GLOBAL_ACTIONS[n]())}}),document.addEventListener("keyup",function(e){/hidden/i.test(t.classList.toString())||t.classList.add("hidden"),/hidden/i.test(i.classList.toString())||i.classList.add("hidden"),/hidden/i.test(r.classList.toString())||r.classList.add("hidden")}),document.getElementById("audioclip").addEventListener("mousemove",function(e){var t=document.getElementById("tooltip");t.style.top=e.clientY+"px",t.style.left=e.clientX+"px",t.innerText=toHHMMssmmm(e.layerX/wavesurfer.drawer.width*wavesurfer.getDuration()).split(",")[0],t.style.display="block"}),document.getElementById("audioclip").addEventListener("mouseleave",function(){document.getElementById("tooltip").style.display="none"})}var wavesurfer=Object.create(WaveSurfer),transcript,silences,highlights,strikes,pageOptions,getParams,skipSilences=!1,playHighlights=!1,GLOBAL_ACTIONS={play:function(){togglePlayPause(),wavesurfer.playPause()},stop:function(){togglePlayPause(),wavesurfer.stop(),readWords()},rewind:function(){wavesurfer.skipBackward(5)},speedx05:function(){wavesurfer.setPlaybackRate(.5),activeSpeed()},speedx1:function(){wavesurfer.setPlaybackRate(1),activeSpeed()},speedx125:function(){wavesurfer.setPlaybackRate(1.25),activeSpeed()},speedx15:function(){wavesurfer.setPlaybackRate(1.5),activeSpeed()},speedx175:function(){wavesurfer.setPlaybackRate(1.75),activeSpeed()},speedx2:function(){wavesurfer.setPlaybackRate(2),activeSpeed()},skipsilence:function(){skipSilences=!skipSilences},playhighlight:function(){playHighlights||(getHighlights(),wavesurfer.seekTo(highlights[0]/wavesurfer.getDuration())),playHighlights=!playHighlights},"toggle-hints":function(){var e=document.getElementById("hints-switch");e.classList.toggle("off"),document.getElementById("hints").classList.toggle("hidden"),/off/i.test(e.classList.toString())?(e.innerHTML="Turn Hints On",setCookie("hints","off")):(e.innerHTML="Turn Hints Off",setCookie("hints","on"))},"toggle-help":function(){var e=document.getElementById("help-switch");e.classList.toggle("off"),/off/i.test(e.classList.toString())?(e.innerHTML="Show at Startup",setCookie("help","off")):(e.innerHTML="Don't Show at Startup",setCookie("help","on"))},"close-export":function(){document.getElementById("export-wrapper").classList.add("invisible"),setTimeout(function(){document.getElementById("export-wrapper").classList.add("hidden")},50)},"close-help":function(){document.getElementById("help-wrapper").classList.add("invisible"),setTimeout(function(){document.getElementById("help-wrapper").classList.add("hidden")},50)},"export-srt":function(){var e,t,r,i=transcript.results[0].results,s=transcript.results[0].speaker_labels,n=1,a=0,o=Array(),l=document.getElementById("export-highlight").checked;i.forEach(function(i,d){var c;i.alternatives.forEach(function(e,t){e.confidence>0&&(c=e,maxAlternativeIndex=t)}),r="",c.timestamps.forEach(function(i,n){e=s[a++].speaker,l?i[3]&&i[3].highlight&&(e!=t&&(r+="("+e+")"),r+="<b>"+i[0]+"</b>"):(e!=t&&(r+="("+e+") "),i[3]?i[3].strike||(i[3].highlight?r+="<b>"+i[0]+"</b>":r+=i[0]):r+=i[0]),t=e}),""!=r.trim()&&(o.push(n+++"\n"),o.push(toHHMMssmmm(c.timestamps[0][1])+" --\x3e "+toHHMMssmmm(c.timestamps[c.timestamps.length-1][2])+"\n"),o.push(r+"\n\n"))});var d=new Blob(o,{type:"text/srt"});saveAs(d,"transcript.srt"),GLOBAL_ACTIONS["close-export"]()},"export-vtt":function(){var e,t,r,i=transcript.results[0].results,s=transcript.results[0].speaker_labels,n=1,a=0,o=Array(),l=document.getElementById("export-highlight").checked;o.push("WEBVTT\n\n"),i.forEach(function(i,d){var c;i.alternatives.forEach(function(e,t){e.confidence>0&&(c=e,maxAlternativeIndex=t)}),r="",c.timestamps.forEach(function(i,n){e=s[a++].speaker,l?i[3]&&i[3].highlight&&(e!=t&&(r+="("+e+") "),r+="<b>"+i[0]+"</b>"):(e!=t&&(r+="("+e+") "),i[3]?i[3].strike||(i[3].highlight?r+="<b>"+i[0]+"</b>":r+=i[0]):r+=i[0]),t=e}),""!=r.trim()&&(o.push(n+++"\n"),o.push(toHHMMssmmm(c.timestamps[0][1]).replace(",",".")+" --\x3e "+toHHMMssmmm(c.timestamps[c.timestamps.length-1][2]).replace(",",".")+"\n"),o.push(r+"\n\n"))});var d=new Blob(o,{type:"text/vtt"});saveAs(d,"transcript.vtt"),GLOBAL_ACTIONS["close-export"]()},"export-pdf":function(){var e,t,r=transcript.results[0].results,i=transcript.results[0].speaker_labels,s=Array(),n="",a=document.getElementById("export-highlight").checked,o=document.getElementById("no-timestamps").checked;r.forEach(function(e,t){var r;e.alternatives.forEach(function(e,t){e.confidence>0&&(r=e,maxAlternativeIndex=t)}),r.timestamps.forEach(function(e,t){s.push(e)})});for(var l=0;l<s.length-1;){if(e=i[l].speaker,t=i[l+1].speaker,a){var d=e+": ";o||(d+="["+toHHMMssmmm(s[l][1]).replace(",",".")+"]")}else n+=e+": ",o||(n+="["+toHHMMssmmm(s[l][1]).replace(",",".")+"] ");do{try{t=i[l+1].speaker}catch(e){t=null}a?s[l][3]&&s[l][3].highlight&&(n+=d,d="",n+=s[l][0]):s[l][3]?s[l][3].strike||(s[l][3].highlight,n+=s[l][0]):n+=s[l][0],l++}while(e==t&&l<s.length);a&&""==d?(o||(n+="["+toHHMMssmmm(s[l-1][2]).replace(",",".")+"]"),n+="\n\n"):a||d||(o||(n+="["+toHHMMssmmm(s[l-1][2]).replace(",",".")+"]"),n+="\n\n")}var c=new jsPDF;c.setFontSize(10);for(var u=c.splitTextToSize(n,160);u.length>0;)c.text(u.splice(0,70),10,10),c.addPage();c.save("transcript.pdf"),GLOBAL_ACTIONS["close-export"]()},"export-doc":function(){var e,t,r=transcript.results[0].results,i=transcript.results[0].speaker_labels,s=Array(),n="",a=document.getElementById("export-highlight").checked,o=document.getElementById("no-timestamps").checked;r.forEach(function(e,t){var r;e.alternatives.forEach(function(e,t){e.confidence>0&&(r=e,maxAlternativeIndex=t)}),r.timestamps.forEach(function(e,t){s.push(e)})});for(var l=0;l<s.length-1;){if(e=i[l].speaker,t=i[l+1].speaker,a){var d="<w:p><w:r><w:t>"+e+": ";o||(d+="["+toHHMMssmmm(s[l][1]).replace(",",".")+"]"),d+=" </w:t></w:r>"}else n+="<w:p><w:r><w:t>"+e+": ",o||(n+="["+toHHMMssmmm(s[l][1]).replace(",",".")+"]"),n+=" </w:t></w:r>";do{try{t=i[l+1].speaker}catch(e){t=null}a?s[l][3]&&(s[l][3].strike||s[l][3].highlight&&(n+=d,d="",n+='<w:r><w:rPr><w:highlight w:val="yellow" /></w:rPr><w:t>'+s[l][0]+"</w:t></w:r>")):s[l][3]?s[l][3].strike||(s[l][3].highlight?n+='<w:r><w:rPr><w:highlight w:val="yellow" /></w:rPr><w:t>'+s[l][0]+"</w:t></w:r>":n+="<w:r><w:t>"+s[l][0]+"</w:t></w:r>"):n+="<w:r><w:t>"+s[l][0]+"</w:t></w:r>",l++}while(e==t&&l<s.length);a&&""==d?(n+="<w:r><w:t> ",o||(n+="["+toHHMMssmmm(s[l-1][2]).replace(",",".")+"]"),n+="\n\n</w:t></w:r></w:p>"):a||d||(n+="<w:r><w:t> ",o||(n+="["+toHHMMssmmm(s[l-1][2]).replace(",",".")+"]"),n+="\n\n</w:t></w:r></w:p>")}!function(e,t){JSZipUtils.getBinaryContent(e,t)}("./src/template.docx",function(e,t){if(e)throw e;var r=new JSZip(t),i=(new Docxtemplater).loadZip(r);i.setData({xml:n});try{i.render()}catch(e){var s={message:e.message,name:e.name,stack:e.stack,properties:e.properties};throw console.log(JSON.stringify({error:s})),e}var a=i.getZip().generate({type:"blob",mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});saveAs(a,"transcript.docx")}),GLOBAL_ACTIONS["close-export"]()}};document.addEventListener("DOMContentLoaded",function(){"id"in(getParams=getParameters())?getURLs(getParams.id):(pageOptions={metaURL:"transcript/new-york-rock_meta.json",transcriptURL:"transcript/new-york-rock_prepared.json",audioURL:"audio/new-york-rock.mp3"},init())});