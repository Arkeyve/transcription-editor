"use strict";var WaveSurfer={defaultParams:{audioContext:null,audioRate:1,autoCenter:!0,backend:"WebAudio",barHeight:1,closeAudioContext:!1,container:null,cursorColor:"#333",cursorWidth:1,dragSelection:!0,fillParent:!0,forceDecode:!1,height:128,hideScrollbar:!1,interact:!0,loopSelection:!0,mediaContainer:null,mediaControls:!1,mediaType:"audio",minPxPerSec:20,partialRender:!1,pixelRatio:window.devicePixelRatio||screen.deviceXDPI/screen.logicalXDPI,progressColor:"#555",normalize:!1,renderer:"MultiCanvas",scrollParent:!1,skipLength:2,splitChannels:!1,waveColor:"#999"},init:function(e){if(this.params=WaveSurfer.util.extend({},this.defaultParams,e),this.container="string"==typeof e.container?document.querySelector(this.params.container):this.params.container,!this.container)throw new Error("Container element not found");if(null==this.params.mediaContainer?this.mediaContainer=this.container:"string"==typeof this.params.mediaContainer?this.mediaContainer=document.querySelector(this.params.mediaContainer):this.mediaContainer=this.params.mediaContainer,!this.mediaContainer)throw new Error("Media Container element not found");this.savedVolume=0,this.isMuted=!1,this.tmpEvents=[],this.currentAjax=null,this.createDrawer(),this.createBackend(),this.createPeakCache(),this.isDestroyed=!1},createDrawer:function(){var e=this;this.drawer=Object.create(WaveSurfer.Drawer[this.params.renderer]),this.drawer.init(this.container,this.params),this.drawer.on("redraw",function(){e.drawBuffer(),e.drawer.progress(e.backend.getPlayedPercents())}),this.drawer.on("click",function(t,r){setTimeout(function(){e.seekTo(r)},0)}),this.drawer.on("scroll",function(t){e.params.partialRender&&e.drawBuffer(),e.fireEvent("scroll",t)})},createBackend:function(){var e=this;this.backend&&this.backend.destroy(),"AudioElement"==this.params.backend&&(this.params.backend="MediaElement"),"WebAudio"!=this.params.backend||WaveSurfer.WebAudio.supportsWebAudio()||(this.params.backend="MediaElement"),this.backend=Object.create(WaveSurfer[this.params.backend]),this.backend.init(this.params),this.backend.on("finish",function(){e.fireEvent("finish")}),this.backend.on("play",function(){e.fireEvent("play")}),this.backend.on("pause",function(){e.fireEvent("pause")}),this.backend.on("audioprocess",function(t){e.drawer.progress(e.backend.getPlayedPercents()),e.fireEvent("audioprocess",t)})},createPeakCache:function(){this.params.partialRender&&(this.peakCache=Object.create(WaveSurfer.PeakCache),this.peakCache.init())},getDuration:function(){return this.backend.getDuration()},play:function(e,t){this.fireEvent("interaction",this.play.bind(this,e,t)),this.backend.play(e,t)},pause:function(){this.backend.isPaused()||this.backend.pause()},playPause:function(){this.backend.isPaused()?this.play():this.pause()},isPlaying:function(){return!this.backend.isPaused()},skipBackward:function(e){this.skip(-e||-this.params.skipLength)},skipForward:function(e){this.skip(e||this.params.skipLength)},skip:function(e){var t=this.getCurrentTime()||0,r=this.getDuration()||1;t=Math.max(0,Math.min(r,t+(e||0))),this.seekAndCenter(t/r)},seekAndCenter:function(e){this.seekTo(e),this.drawer.recenter(e)},seekTo:function(e){this.fireEvent("interaction",this.seekTo.bind(this,e));var t=this.backend.isPaused();t||this.backend.pause();var r=this.params.scrollParent;this.params.scrollParent=!1,this.backend.seekTo(e*this.getDuration()),this.drawer.progress(this.backend.getPlayedPercents()),t||this.backend.play(),this.params.scrollParent=r,this.fireEvent("seek",e)},stop:function(){this.pause(),this.seekTo(0),this.drawer.progress(0)},setVolume:function(e){this.backend.setVolume(e)},getVolume:function(){return this.backend.getVolume()},getCurrentTime:function(){return this.backend.getCurrentTime()},setCurrentTime:function(e){this.getDuration()>=e?this.seekTo(1):this.seekTo(e/this.getDuration())},setPlaybackRate:function(e){this.backend.setPlaybackRate(e)},getPlaybackRate:function(){return this.backend.getPlaybackRate()},toggleMute:function(){this.setMute(!this.isMuted)},setMute:function(e){e!==this.isMuted&&(e?(this.savedVolume=this.backend.getVolume(),this.backend.setVolume(0),this.isMuted=!0):(this.backend.setVolume(this.savedVolume),this.isMuted=!1))},getMute:function(){return this.isMuted},getFilters:function(){return this.backend.filters||[]},toggleScroll:function(){this.params.scrollParent=!this.params.scrollParent,this.drawBuffer()},toggleInteraction:function(){this.params.interact=!this.params.interact},drawBuffer:function(){var e=Math.round(this.getDuration()*this.params.minPxPerSec*this.params.pixelRatio),t=this.drawer.getWidth(),r=e,i=this.drawer.getScrollX(),a=Math.min(i+t,r);if(this.params.fillParent&&(!this.params.scrollParent||e<t)&&(i=0,a=r=t),this.params.partialRender)for(var n=this.peakCache.addRangeToPeakCache(r,i,a),s=0;s<n.length;s++){o=this.backend.getPeaks(r,n[s][0],n[s][1]);this.drawer.drawPeaks(o,r,n[s][0],n[s][1])}else{i=0,a=r;var o=this.backend.getPeaks(r,i,a);this.drawer.drawPeaks(o,r,i,a)}this.fireEvent("redraw",o,r)},zoom:function(e){this.params.minPxPerSec=e,this.params.scrollParent=!0,this.drawBuffer(),this.drawer.progress(this.backend.getPlayedPercents()),this.drawer.recenter(this.getCurrentTime()/this.getDuration()),this.fireEvent("zoom",e)},loadArrayBuffer:function(e){this.decodeArrayBuffer(e,function(e){this.isDestroyed||this.loadDecodedBuffer(e)}.bind(this))},loadDecodedBuffer:function(e){this.backend.load(e),this.drawBuffer(),this.fireEvent("ready")},loadBlob:function(e){var t=this,r=new FileReader;r.addEventListener("progress",function(e){t.onProgress(e)}),r.addEventListener("load",function(e){t.loadArrayBuffer(e.target.result)}),r.addEventListener("error",function(){t.fireEvent("error","Error reading file")}),r.readAsArrayBuffer(e),this.empty()},load:function(e,t,r){switch(this.empty(),this.isMuted=!1,this.params.backend){case"WebAudio":return this.loadBuffer(e,t);case"MediaElement":return this.loadMediaElement(e,t,r)}},loadBuffer:function(e,t){var r=function(t){return t&&this.tmpEvents.push(this.once("ready",t)),this.getArrayBuffer(e,this.loadArrayBuffer.bind(this))}.bind(this);if(!t)return r();this.backend.setPeaks(t),this.drawBuffer(),this.tmpEvents.push(this.once("interaction",r))},loadMediaElement:function(e,t,r){var i=e;if("string"==typeof e)this.backend.load(i,this.mediaContainer,t,r);else{var a=e;this.backend.loadElt(a,t),i=a.src}this.tmpEvents.push(this.backend.once("canplay",function(){this.drawBuffer(),this.fireEvent("ready")}.bind(this)),this.backend.once("error",function(e){this.fireEvent("error",e)}.bind(this))),t&&this.backend.setPeaks(t),t&&!this.params.forceDecode||!this.backend.supportsWebAudio()||this.getArrayBuffer(i,function(e){this.decodeArrayBuffer(e,function(e){this.backend.buffer=e,this.backend.setPeaks(null),this.drawBuffer(),this.fireEvent("waveform-ready")}.bind(this))}.bind(this))},decodeArrayBuffer:function(e,t){this.arraybuffer=e,this.backend.decodeArrayBuffer(e,function(r){this.isDestroyed||this.arraybuffer!=e||(t(r),this.arraybuffer=null)}.bind(this),this.fireEvent.bind(this,"error","Error decoding audiobuffer"))},getArrayBuffer:function(e,t){var r=this,i=WaveSurfer.util.ajax({url:e,responseType:"arraybuffer"});return this.currentAjax=i,this.tmpEvents.push(i.on("progress",function(e){r.onProgress(e)}),i.on("success",function(e,i){t(e),r.currentAjax=null}),i.on("error",function(e){r.fireEvent("error","XHR error: "+e.target.statusText),r.currentAjax=null})),i},onProgress:function(e){if(e.lengthComputable)var t=e.loaded/e.total;else t=e.loaded/(e.loaded+1e6);this.fireEvent("loading",Math.round(100*t),e.target)},exportPCM:function(e,t,r,i){e=e||1024,i=i||0,t=t||1e4,r=r||!1;var a=this.backend.getPeaks(e,i),n=[].map.call(a,function(e){return Math.round(e*t)/t}),s=JSON.stringify(n);return r||window.open("data:application/json;charset=utf-8,"+encodeURIComponent(s)),s},exportImage:function(e,t){return e||(e="image/png"),t||(t=1),this.drawer.getImage(e,t)},cancelAjax:function(){this.currentAjax&&(this.currentAjax.xhr.abort(),this.currentAjax=null)},clearTmpEvents:function(){this.tmpEvents.forEach(function(e){e.un()})},empty:function(){this.backend.isPaused()||(this.stop(),this.backend.disconnectSource()),this.cancelAjax(),this.clearTmpEvents(),this.drawer.progress(0),this.drawer.setWidth(0),this.drawer.drawPeaks({length:this.drawer.getWidth()},0)},destroy:function(){this.fireEvent("destroy"),this.cancelAjax(),this.clearTmpEvents(),this.unAll(),this.backend.destroy(),this.drawer.destroy(),this.isDestroyed=!0}};WaveSurfer.create=function(e){var t=Object.create(WaveSurfer);return t.init(e),t};